pipeline {
    agent any

    environment {
        domain_name = 'jenkinsadddata'
        service_port = '3001'
    }

    stages {
        stage('Clone Code') {
            steps {
                git branch: 'main', url: 'https://github.com/rakcomputing/jenkinsapp'
                sh 'ls -lrt'
                sh 'pwd'
                sh '''
                    echo "ðŸ“¥ This is the code clone"
                    ls
                    docker version
                '''
            }
        }

        stage("Build") {
            steps {
                sh '''
                    echo "ðŸ“¦ Building Docker image..."
                    ls -la
                    docker buildx build -t reactjs_automat_deploy .
                '''
            }
        }

        stage("Check Container") {
            steps {
                sh '''
                    echo "ðŸ§¼ Removing old container (if exists)..."
                    docker rm -f reactjs-cont || true
                    echo "âœ… Done."
                '''
            }
        }

        stage("Deploy") {
            steps {
                sh '''
                    echo "ðŸš€ Deploying container on port ${service_port}"
                    docker run -dp ${service_port}:3000 \
                        --name reactjs-cont \
                        reactjs_automat_deploy
                '''
            }
        }

        stage("Add Domain Name") {
            steps {
                sh '''
                    echo "ðŸ”§ Creating NGINX config for domain ${domain_name}.rakdev.online..."

                    CONFIG_PATH="/etc/nginx/conf.d/${domain_name}.conf"

                    if [ -f "$CONFIG_PATH" ]; then
                        echo "ðŸ—‘ï¸ Removing existing config: $CONFIG_PATH"
                        sudo rm -f "$CONFIG_PATH"
                    fi

                    sudo tee "$CONFIG_PATH" > /dev/null <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${domain_name}.rakdev.online;

    location / {
        proxy_pass http://localhost:${service_port};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

                    echo "âœ… NGINX config created."
                    echo "ðŸ” Reloading NGINX..."
                    sudo nginx -t && sudo systemctl reload nginx && echo "âœ… NGINX reloaded."
                '''
            }
        }
    }
}
